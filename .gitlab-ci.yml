stages:
  - test
  - deploy

cache:
  paths:
    - _build
    - deps
    - apps/frontend/node_modules

mix:test:
  stage: test
  tags:
    - docker
  image: nikolauska/phoenix:latest
  variables:
    MIX_ENV: test
  script:
    - mix deps.get
    - mix compile
    - mix test --cover

mix:lint:
  stage: test
  tags:
    - docker
  image: nikolauska/phoenix:latest
  variables:
    MIX_ENV: test
  script:
    - mix setup
    - mix lint

mix:release:
  stage: test
  tags:
    - docker
  image: nikolauska/phoenix:latest
  variables:
    MIX_ENV: prod
    NODE_ENV: prod
  script:
    - mix setup
    - mix release --warnings-as-errors

coverage:
  stage: deploy
  tags:
    - docker
  image: nikolauska/phoenix:latest
  only:
    - branches@osasto-kuikka/kuikka-website
  variables:
    MIX_ENV: test
  script:
    - mix setup
    - mix coveralls

deploy:
  stage: deploy
  tags:
    - osastokuikka
    - shell
  only:
    - branches@osasto-kuikka/kuikka-website
  variables:
    MIX_ENV: prod
    NODE_ENV: prod
    HOST: "osastokuikka.com"
    PORT: "4000"
  script:
    - mix setup
    - mix release
    - rel/kuikka_website/bin/kuikka_website stop
    - rel/kuikka_website/bin/kuikka_website start
